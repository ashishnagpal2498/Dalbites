stages:          # List of stages for jobs, and their order of execution
  - test
  - build
  - publish_image # Add image to DockerHub
  
variables:
  BACKEND_IMAGE:  maven:3.8.3-openjdk-17  # Base image for the backend   

# # test_backend
# test_backend:
#   stage: test
#   image: $BACKEND_IMAGE
#   script:
#     - cd Backend
#     - mvn test
#   only:
#     - develop
#     - staging

# # build_backend
# build_backend:
#   stage: build
#   image: $BACKEND_IMAGE
#   script:
#     - cd Backend
#     - mvn clean install
#   only:
#     - develop
#     - staging

publish-backend:
  image: docker:20.10.16
  stage: publish_image
  variables:
    DOCKER_TLS_CERTDIR: ''
    #DOCKER_HOST: 'tcp://localhost:2375' # Changed host as docker login wasn't working
  services:
    - docker:20.10.16-dind
  before_script:
    - docker --version
    - cat /etc/hosts
    - echo "$DOCKER_LOGIN_PASSWORD" | docker login -u "$DOCKER_LOGIN_USERNAME" --password-stdin #docker.io
  script:
    - cd Backend
    - pwd

    # Checking Configuration of running DockerInDocker
    - systemctl status docker
    - cat /etc/docker/daemon.json
    - docker info

    - docker build -t asdc-dalbites-backend:$CI_COMMIT_SHORT_SHA .
    - docker push asdc-dalbites-backend:$CI_COMMIT_SHORT_SHA
  only:
    - develop
    - staging
