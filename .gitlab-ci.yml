stages:          # List of stages for jobs, and their order of execution
  - test
  - build
  - publish_image # Add image to DockerHub
  - deploy

variables:
  # Define your environment-specific variables here
  FRONTEND_IMAGE: node:18-alpine3.17  # Base image for the frontend
  BACKEND_IMAGE: maven:3.8.3-openjdk-17  # Base image for the backend

# ------------ Test Stage ----------------------
# test_backend
test_backend:
  stage: test
  image: $BACKEND_IMAGE
  before_script:
    - cd Backend
    - echo "List all files"
    - ls
    - mvn --version
    - mvn clean
  script:
    - mvn test
  only:
    - develop
    - staging
    - backend

#test_frontend
# test_frontend:
#   stage: test
#   image: $FRONTEND_IMAGE
#   before_script:
#     - npm install -g expo-cli
#   script:
#     - cd Frontend
#     - npm install
#     - npm run test
#   only:
#     - develop
#     - staging
#     - frontend

#---------------- Build Stage -------------------------

# build_backend
build_backend:
  stage: build
  image: $BACKEND_IMAGE
  script:
    - cd Backend
    - mvn clean install
  only:
    - develop
    - staging
    - backend

#Build
build_frontend:
  stage: build
  image: $FRONTEND_IMAGE
  before_script:
    - npm install -g expo-cli
  script:
    - cd Frontend
    - npm install

#---------------------- Publish Stage -------------------------------

publish-backend:
  image: docker:latest
  stage: publish_image
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: '' #certs
    DOCKER_HOST: 'tcp://docker:2375'
  before_script:
    - docker --version
  #   - cat /etc/hosts # Check available hosts
  #   - echo "$DOCKER_LOGIN_PASSWORD" | docker login -u "$DOCKER_LOGIN_USERNAME" --password-stdin docker.io
  script:
    - cd Backend
    - pwd
    - echo $SERVER_IP
    - docker --version
    - docker login -u $DOCKER_LOGIN_USERNAME -p $DOCKER_LOGIN_PASSWORD
    - docker build -t $DOCKER_LOGIN_USERNAME/dalbites:$CI_COMMIT_SHORT_SHA .
    - docker push $DOCKER_LOGIN_USERNAME/dalbites:$CI_COMMIT_SHORT_SHA

  only:
    - develop
    - staging
