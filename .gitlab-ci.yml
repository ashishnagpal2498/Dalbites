stages:          # List of stages for jobs, and their order of execution
  - test
  - build
  - publish_image # Add image to DockerHub
  
variables:
  BACKEND_IMAGE:  maven:3.8.3-openjdk-17  # Base image for the backend   

# test_backend
test_backend:
  stage: test
  image: $BACKEND_IMAGE
  script:
    - cd Backend
    - mvn test
  only:
    - develop
    - staging

# build_backend
build_backend:
  stage: build
  image: $BACKEND_IMAGE
  script:
    - cd Backend
    - mvn clean install
  only:
    - develop
    - staging

publish-backend:
  image: docker:latest
  stage: publish_image
  variables:
    DOCKER_TLS_CERTDIR: '/certs'
  services:
    - docker:dind
  before_script:
    - docker login -u $DOCKER_LOGIN_USERNAME -p $DOCKER_LOGIN_PASSWORD
  script:
    - cd Backend
    - pwd
    - echo "Inside Backend directory"
    - echo $SERVER_IP
    - docker --version
    - docker build -t asdc-dalbites-backend:$CI_COMMIT_SHORT_SHA .
    - docker push asdc-dalbites-backend:$CI_COMMIT_SHORT_SHA
  only:
    - develop
    - staging
